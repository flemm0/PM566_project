```{r load libraries to read in data types}
library(haven)
library("readxl")
library(data.table)
library(tidyverse)
library(dtplyr)
library(httr)
library(xml2)
library(rvest)
```


Main source of data:

https://www.ars.usda.gov/northeast-area/beltsville-md-bhnrc/beltsville-human-nutrition-research-center/food-surveys-research-group/docs/wweia-documentation-and-data-sets/


Questions:
Insulin resistance and diabetes is a growing health issue for Americans. Causes of this includes consumption of foods high in carbohydrates and saturated fats, causing blood glucose levels to spike and insulin is needed to bring the blood glucose levels back down to normal. Over time, consistent high blood glucose spikes lead to the body becoming accustomed to high amounts of sugar, and therefore acquiring insulin resistance. In this project, I will be investigating what attributes cause people to eat foods that lead to blood glucose spikes. 
* What time and/or day of the week do people generally eat foods high in sugar/saturated fats?
* Does having a dietary restriction affect sugar/fat consumption?
* Does sugar consumption vary by age, ethnicity, gender, or pregnancy status?
* Does source of food or whether the meal was eaten at home have an effect?
        

        
```{r Read in data sets from website, cache = TRUE}


fs_d1 <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.xpt")



demographic <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DEMO.xpt")



food_categories <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_drxfcd.xpt")

```

```{r}
fs_d2 <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR2IFF.xpt")
```


#### Data Cleaning

```{r Changing column names, warning = FALSE}
# Get get all of the column labels in a data frame
fs_d1_labels <- purrr::map_df(fs_d1, ~attributes(.x))

demographic_labels <- purrr::map_df(demographic, ~attributes(.x))

fc_labels <- purrr::map_df(food_categories, ~attributes(.x))


# gsub() the spaces to underscores and put into vector
fs_d1_labels <- gsub(" ", "_", fs_d1_labels$label) %>%
  as.vector() %>%
  tolower() %>%
  unique()

demographic_labels <- gsub(" ", "_", demographic_labels$label) %>%
  as.vector() %>%
  tolower()

fc_labels <- gsub(" ", "_", fc_labels$label) %>%
  as.vector() %>%
  tolower()
 

#reassign names
names(fs_d1) <- fs_d1_labels

names(demographic) <- demographic_labels

names(food_categories) <- fc_labels

# check for successful column name conversion
names(fs_d1)
names(demographic)
names(food_categories)
```


```{r convert to data tables}
fs_d1 <- as.data.table(fs_d1)
food_categories <- as.data.table(food_categories)
demographic <- as.data.table(demographic)
```



Remove unneeded columns in demographic data table
```{r filter demographic table}
names(demographic)

demographic <- demographic[, respondent_sequence_number:pregnancy_status_at_exam]

head(demographic)
```


```{r columns that contain NAs that will have to be accounted for}
colSums(is.na(demographic))
```


Change categorical columns from number codes to categorical variables in demographic table
```{r decoding categorical variables in demographic table}
demographic[, `interview/examination_status` := fifelse(`interview/examination_status` == 1, "interview_only", "interview_and_mec_examined")]

demographic[, gender := fifelse(gender == 1, "male", "female")]

demographic[, `race/hispanic_origin` := fifelse(`race/hispanic_origin` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin` == 4, "non-hispanic_black", "other_race_incl_multiracial"))))]

demographic[, `race/hispanic_origin_w/_nh_asian` := fifelse(`race/hispanic_origin_w/_nh_asian` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin_w/_nh_asian` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin_w/_nh_asian` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin_w/_nh_asian` == 4, "non-hispanic_black", 
                                                                           fifelse(`race/hispanic_origin_w/_nh_asian` == 6, "non-hispanic_asian", "other_race_incl_multiracial")))))]

demographic[, six_month_time_period := fifelse(six_month_time_period == 1, "nov1-apr30", 
                                               fifelse(six_month_time_period == 2, "may1-oct31", NA_character_))]

demographic[, country_of_birth := fifelse(country_of_birth == 1, "united_states", 
                                          fifelse(country_of_birth == 2, "other",
                                                  fifelse(country_of_birth == 77, "refused", "dont_know")))]

demographic[, length_of_time_in_us := fifelse(length_of_time_in_us == 1, "less_than_5", 
                                              fifelse(length_of_time_in_us == 2, "between_5_and_15",
                                                      fifelse(length_of_time_in_us == 3, "between_15_and_30",
                                                              fifelse(length_of_time_in_us == 4, "30_or_more",
                                                                      fifelse(length_of_time_in_us == 77, "refused", 
                                                                              fifelse(length_of_time_in_us == 99, "dont_know", NA_character_))))))]

demographic[, pregnancy_status_at_exam := fifelse(pregnancy_status_at_exam == 1, "pregnant",
                                                  fifelse(pregnancy_status_at_exam == 2, "not_pregnant",
                                                          fifelse(pregnancy_status_at_exam == 3, "cannot_ascertain", NA_character_)))]
```

```{r create age category variable for demographic table}
demographic[, age_category := fifelse(age_in_years_at_screening %between% c(1,3), "1-3",
                                      fifelse(age_in_years_at_screening %between% c(4,8), "4-8",
                                              fifelse(age_in_years_at_screening %between% c(9,13), "9-13",
                                                      fifelse(age_in_years_at_screening %between% c(14,18), "14-18",
                                                              fifelse(age_in_years_at_screening %between% c(19,30), "19-30",
                                                                      fifelse(age_in_years_at_screening %between% c(31,50), "31-50", 
                                                                              fifelse(age_in_years_at_screening %between% c(51,70), "51-70", "70+")))))))]
```

Categorize the answers in the food survey.
```{r Categorize food survey day 1}
fs_d1[, intake_day_of_the_week := fifelse(intake_day_of_the_week == 1, "Sunday",
                                          fifelse(intake_day_of_the_week == 2, "Monday",
                                                  fifelse(intake_day_of_the_week == 3, "Tuesday",
                                                          fifelse(intake_day_of_the_week == 4, "Wednesday",
                                                                  fifelse(intake_day_of_the_week == 5, "Thursday", 
                                                                          fifelse(intake_day_of_the_week == 6, "Friday", "Saturday"))))))]
```


To answer the questions, I will be using this table of the Recommended Dietary Allowances and Adequate Intakes from the Food and Nutrition Board: https://www.ncbi.nlm.nih.gov/books/NBK56068/table/summarytables.t4/?report=objectonly

```{r Recommended Dietary Allowances}
html <- read_html("https://www.ncbi.nlm.nih.gov/books/NBK56068/table/summarytables.t4/?report=objectonly")

rda <- html %>% 
  html_table()

rda %>%
  knitr::kable()
```


```{r filter food_category table and rename cols}
food_categories <- food_categories[, -(former_short_food_code_description:former_long_food_code_description)]

setnames(food_categories, old = names(food_categories), new = c("USDA_food_code", "short_description", "long_description"))

```

```{r filter day 1 survey}
fs_d1 <- fs_d1[, c(1:30)]

```



```{r}
joined_df <- merge(
  x = merge(
    x = fs_d1, 
    y = food_categories, 
    by.x = "usda_food_code", 
    by.y = "USDA_food_code"),
  y = demographic,
  by.x = "respondent_sequence_number",
  by.y = "respondent_sequence_number"
)
```

What is the age distribution of the people in the data set?
Ethnicity?

```{r}

summary(demographic[, age_in_years_at_screening])

ggplot(demographic) +
  geom_bar(aes(x = age_in_years_at_screening))

```

```{r plotting ethnicities}
ggplot(demographic) +
  geom_bar(aes(x = `race/hispanic_origin_w/_nh_asian`, fill = `race/hispanic_origin_w/_nh_asian`))
```
White people are represented the most in this data set.

```{r}
fs_d1[, sum(`total_sugars_(gm)`), by = respondent_sequence_number] %>%
  ggplot() +
  geom_histogram(aes(x = V1), bins = 200) +
  geom_vline(xintercept = 130)
```














```{r}
joined_df[kcal == 0, .(unique(short_description))]
```



```{r}
joined_df[, sum(kcal, na.rm = TRUE), by = seq_num] %>%
  ggplot(aes(x = V1)) +
  geom_histogram(bins = 200) +
  xlab("Average Daily Calories")
```
```{r temporal patterns separated by day and time}
joined_df[, .(.N), by = c("time_ate", "intake_day_of_week")][order(intake_day_of_week, time_ate)] %>%
  ggplot(aes(x = time_ate, y = N)) +
  geom_line() +
  facet_wrap(~intake_day_of_week, nrow = 3)
```


```{r temporal eating patterns separated by just time}
joined_df[, .(.N), by = time_ate] %>%
  ggplot(aes(x = time_ate, y = N)) +
  geom_line()
```





```{r}
joined_df <- merge(
  x = merge(
    x = food_survey, 
    y = food_categories, 
    by.x = "DR1IFDCD", 
    by.y = "food_code"),
  y = demographic,
  by.x = "SEQN",
  by.y = "SEQN"
)
```






