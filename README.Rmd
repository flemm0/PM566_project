---
title: "PM566 Midterm Project"
author: "Flemming Wu"
date: "`r Sys.Date()`"
output: github_document
always_allow_html: true
---


Main source of data:

https://www.ars.usda.gov/northeast-area/beltsville-md-bhnrc/beltsville-human-nutrition-research-center/food-surveys-research-group/docs/wweia-documentation-and-data-sets/


Questions:\
Insulin resistance and diabetes is a growing health issue for Americans. Causes of this includes consumption of foods high in carbohydrates and saturated fats, causing blood glucose levels to spike and insulin is needed to bring the blood glucose levels back down to normal. Over time, consistent high blood glucose spikes lead to the body becoming accustomed to high amounts of sugar, and therefore acquiring insulin resistance. In this project, I will be investigating what attributes cause people to eat foods that lead to blood glucose spikes.\

* What time and/or day of the week do people generally eat foods high in sugar/saturated fats?
* Does sugar consumption vary by age, ethnicity, gender, or pregnancy status?
* Does source of food or whether the meal was eaten at home have an effect?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
setwd("~/Desktop/PM566/midterm")
```

Load Libraries
```{r load libraries, warning=FALSE, message=FALSE}
library(haven)
library(data.table)
library(tidyverse)
library(dtplyr)
library(httr)
library(xml2)
library(rvest)
```

Read in data from CDC website
```{r Read in data sets from website, cache = TRUE}
fs_d1 <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.xpt")
demographic <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DEMO.xpt")
food_categories <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_drxfcd.xpt")
```

Rename columns with the column labels provided
```{r Changing column names, warning = FALSE}
# Get get all of the column labels in a data frame
fs_d1_labels <- purrr::map_df(fs_d1, ~attributes(.x))

demographic_labels <- purrr::map_df(demographic, ~attributes(.x))

fc_labels <- purrr::map_df(food_categories, ~attributes(.x))


# gsub() the spaces to underscores and put into vector
fs_d1_labels <- gsub(" ", "_", fs_d1_labels$label) 
fs_d1_labels <-  gsub("\\(|\\)", "", fs_d1_labels) %>%
  as.vector() %>%
  tolower() %>%
  unique()

demographic_labels <- gsub(" ", "_", demographic_labels$label) %>%
  as.vector() %>%
  tolower()

fc_labels <- gsub(" ", "_", fc_labels$label) %>%
  as.vector() %>%
  tolower()
 

#reassign names
names(fs_d1) <- fs_d1_labels
names(fs_d1) <- make.names(names(fs_d1))

names(demographic) <- demographic_labels

names(food_categories) <- fc_labels
```

Convert to data table
```{r convert to data tables}
fs_d1 <- as.data.table(fs_d1)
food_categories <- as.data.table(food_categories)
demographic <- as.data.table(demographic)
```

Remove unnecessary columns
```{r}
fs_d1 <- fs_d1[, c(1:30)]
demographic <- demographic[, respondent_sequence_number:pregnancy_status_at_exam]
food_categories <- food_categories[, -(former_short_food_code_description:former_long_food_code_description)]
```

Change categorical columns from number codes to categorical variables in demographic table
```{r decoding categorical variables in demographic table}
demographic[, `interview/examination_status` := fifelse(`interview/examination_status` == 1, "interview_only", "interview_and_mec_examined")]

demographic[, gender := fifelse(gender == 1, "male", "female")]

demographic[, `race/hispanic_origin` := fifelse(`race/hispanic_origin` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin` == 4, "non-hispanic_black", "other_race_incl_multiracial"))))]

demographic[, `race/hispanic_origin_w/_nh_asian` := fifelse(`race/hispanic_origin_w/_nh_asian` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin_w/_nh_asian` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin_w/_nh_asian` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin_w/_nh_asian` == 4, "non-hispanic_black", 
                                                                           fifelse(`race/hispanic_origin_w/_nh_asian` == 6, "non-hispanic_asian", "other_race_incl_multiracial")))))]

demographic[, six_month_time_period := fifelse(six_month_time_period == 1, "nov1-apr30", 
                                               fifelse(six_month_time_period == 2, "may1-oct31", NA_character_))]

demographic[, country_of_birth := fifelse(country_of_birth == 1, "united_states", 
                                          fifelse(country_of_birth == 2, "other",
                                                  fifelse(country_of_birth == 77, "refused", "dont_know")))]

demographic[, length_of_time_in_us := fifelse(length_of_time_in_us == 1, "less_than_5", 
                                              fifelse(length_of_time_in_us == 2, "between_5_and_15",
                                                      fifelse(length_of_time_in_us == 3, "between_15_and_30",
                                                              fifelse(length_of_time_in_us == 4, "30_or_more",
                                                                      fifelse(length_of_time_in_us == 77, "refused", 
                                                                              fifelse(length_of_time_in_us == 99, "dont_know", NA_character_))))))]

demographic[, pregnancy_status_at_exam := fifelse(pregnancy_status_at_exam == 1, "pregnant",
                                                  fifelse(pregnancy_status_at_exam == 2, "not_pregnant",
                                                          fifelse(pregnancy_status_at_exam == 3, "cannot_ascertain", NA_character_)))]
```


Create age category variable for demographic table.
```{r create age category variable for demographic table}
demographic[, age_category := fifelse(age_in_years_at_screening == 0, "<1",
                              fifelse(age_in_years_at_screening %between% c(1,3), "1-3",
                              fifelse(age_in_years_at_screening %between% c(4,8), "4-8",
                              fifelse(age_in_years_at_screening %between% c(9,13), "9-13",
                              fifelse(age_in_years_at_screening %between% c(14,18), "14-18",
                              fifelse(age_in_years_at_screening %between% c(19,30), "19-30",
                              fifelse(age_in_years_at_screening %between% c(31,50), "31-50", 
                              fifelse(age_in_years_at_screening %between% c(51,70), "51-70", "70+"))))))))]
```

Categorize the answers in the food survey. Need day of the week, name of eating occasion, source of food, and if the food was eaten at home categorized.
```{r Categorize food survey day 1 using fifelse}
# create new column for this so it can still be ordered
fs_d1[, intake_day_cat := fifelse(intake_day_of_the_week == 1, "Sunday",
                                          fifelse(intake_day_of_the_week == 2, "Monday",
                                                  fifelse(intake_day_of_the_week == 3, "Tuesday",
                                                          fifelse(intake_day_of_the_week == 4, "Wednesday",
                                                                  fifelse(intake_day_of_the_week == 5, "Thursday", 
                                                                          fifelse(intake_day_of_the_week == 6, "Friday", "Saturday"))))))]

#table(fs_d1$`did_you_eat_this_meal_at_home?`) #1, 2, and 9 are the only answers
fs_d1[, `did_you_eat_this_meal_at_home.` := fifelse(`did_you_eat_this_meal_at_home.` == 1, "yes",
                                                    fifelse(`did_you_eat_this_meal_at_home.` == 2, "no", "dont_know"))]
```

```{r categorize food survey day 1 using xpath and merge}

# for the next categorization steps, I will be reading in tables from the CDC website because they contain many possible values

# categorize the name of eating occasion
# read in name of eating occasion table from CDC website using html and full Xpath
eating_occasion <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[15]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

# merge table into original data table
fs_d1 <- merge(
  x = eating_occasion,
  y = fs_d1,
  by.x = "Code.or.Value",
  by.y = "name_of_eating_occasion"
)

# the merge replaced the old column "name_of_eating_occasion" with "Code.or.Value" from the new table
# I only need the "Value.Description" column so rename it and remove "Code.or.Value" column
setnames(fs_d1, "Value.Description", "eating_occasion")
fs_d1 <- fs_d1[-c(1)]

######################################

# categorize source of food
source_of_food <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[16]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

fs_d1 <- merge(
  x = source_of_food,
  y = fs_d1,
  by.x = "Code.or.Value",
  by.y = "source_of_food"
)

setnames(fs_d1, "Value.Description", "food_source")
fs_d1 <- fs_d1[-c(1)]
```


### Preliminary Results


#### Exploratory Data Analysis

Check dimensions, headers, and footers
```{r merge data}
# First merge all the data tables into one

df <- merge(
  x = merge(
        x = fs_d1, 
        y = demographic,
        by.x = "respondent_sequence_number",
        by.y = "respondent_sequence_number"
  ),
  y = food_categories,
  by.x = "usda_food_code",
  by.y = "food_code"
)

df <- as.data.table(df)
```

```{r check dimensions headers and footers, echo = TRUE, results = "hide"}
dim(df)
head(df)
tail(df)
```

Check variable types
```{r check variable types, echo = TRUE, results = "hide"}
str(df)
```

Check key variables and provide summary statistics in tabular form.

First, check the predicted variables.
```{r summary tables of total sugar and fat consumption}
quantile(df$total_sugars_gm, seq(0, 1, 0.1))

quantile(df$total_saturated_fatty_acids_gm, seq(0, 1, 0.1))
```
Some food items seem to be high in sugars and saturated fats, lets see what it makes sense
```{r view total sugar and fat measurements in food items}
df[total_sugars_gm > 200, .(unique(long_food_code_description), total_sugars_gm)] %>%
  head(n = 20) 

df[total_saturated_fatty_acids_gm > 50, 
                   .(unique(long_food_code_description), total_saturated_fatty_acids_gm)] %>%
  head(n = 20)
```

Next, check the predictor variables.
```{r check predictor variables}
#fs_d1[, .(mean(total_sugars_gm)), by = "time_of_eating_occasion_hh.mm"]
unique(df$food_source)
unique(df$eating_occasion)
unique(df$did_you_eat_this_meal_at_home.)
unique(df$intake_day_of_the_week)
summary(df$age_in_years_at_screening)
unique(df$gender)
unique(df$`race/hispanic_origin_w/_nh_asian`)
```


Summary tables

```{r sugar fat consumption by day of week}
# average and standard deviation of sugar consumption and saturated fatty acid consumption by day of the week
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ),
   by = c("intake_day_of_the_week", "intake_day_cat")][order(intake_day_of_the_week)][, intake_day_cat:num_observations] %>%
  knitr::kable(col.names = c("Day of Food Intake", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))

```
From the summary table above, it can be observed that average sugar and saturated fat consumption is slightly higher on the weekends, as well as Friday and Wednesday.
 
```{r sugar fat consumption by time of consumption}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = hour(time_of_eating_occasion_hh.mm)][order(hour)] %>%
  knitr::kable(col.names = c("Hour of the Day (0 = 12:00 AM - 12:59 AM, 23 = 11:00 PM - 11:59 PM)", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
From the summary table above that groups sugar and saturated fat consumption by the hours that they were consumed, it can be seen that higher sugar and saturated fat consumption occurs between the hours of 8PM to 2AM. 3PM and 4PM also had slightly higher sugar and saturated fat consumption.

```{r sugar and saturated fat consumption by eating occasion}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = eating_occasion][order(avg_total_sugar)] %>%
  knitr::kable(col.names = c("Eating Occasion", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```


```{r sugar and saturated fat consumption by age category}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N,
     min(age_in_years_at_screening)
     ), 
   by = "age_category"][order(V6)][, !c("V6")] %>%
  knitr::kable(col.names = c("Age Range", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```


```{r sugar and saturated fat consumption by gender}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "gender"] %>%
  knitr::kable(col.names = c("Gender", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
```{r sugar and saturated fat consumption by ethnicity}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "race/hispanic_origin_w/_nh_asian"] %>%
  knitr::kable(col.names = c("Race", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
```{r sugar and saturated fat consumption by source of food}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "food_source"][order(-avg_total_sugar, -avg_total_sat_fa)] %>%
  knitr::kable(col.names = c("Food Source", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
```{r sugar and saturated fat consumption by where meal was eaten}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "did_you_eat_this_meal_at_home."][order(-avg_total_sugar)] %>%
  knitr::kable(col.names = c("Meal Eaten at Home", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```





### Data Visualization


#### What time and/or day of the week do people generally eat foods high in sugar/saturated fats?
Plot sugar consumption versus time.
```{r plot sugar and saturated fa consumption against time}
df[, .(mean(total_sugars_gm)), by = "time_of_eating_occasion_hh.mm"] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  geom_smooth(formula = y ~ x, alpha = 0.01, se = FALSE, linetype="dashed")
  labs(x = "Hour of the Day (0 = 12:00 AM - 12:59 AM, 23 = 11:00 PM - 11:59 PM)",
       y = "Average Total Sugar Consumption (grams)",
       title = "Average Sugar Consumption vs Hour of the Day")

df[, .(mean(total_saturated_fatty_acids_gm)), by = "time_of_eating_occasion_hh.mm"] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  geom_smooth(formula = y ~ x, alpha = 0.01, se = FALSE, linetype="dashed") +
  labs(x = "Hour of the Day (0 = 12:00 AM - 12:59 AM, 23 = 11:00 PM - 11:59 PM)",
       y = "Average Total Saturated Fatty Acid Consumption (grams)",
       title = "Average Saturated Fatty Acid Consumption vs Hour of the Day")
```

```{r plot sugar and saturated fa consumption against time grouped by day of the week}
labels <- c("1" = "Sunday", "2" = "Monday", "3" = "Tuesday", "4" = "Wednesday", "5" = "Thursday", "6" = "Friday", "7" = "Saturday")  

df[, .(mean(total_sugars_gm)), by = c("intake_day_of_the_week", "time_of_eating_occasion_hh.mm")][, intake_day_of_the_week := as.character(intake_day_of_the_week)] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  facet_grid(intake_day_of_the_week ~., labeller = labeller(intake_day_of_the_week = labels)) +
  labs(x = "Time of the Day", 
       y = "Average Total Sugar Consumption (grams)",
       title = "Average Total Sugar Consumption vs Time of Day by Day of Week")

df[, .(mean(total_saturated_fatty_acids_gm)), by = c("intake_day_of_the_week", "time_of_eating_occasion_hh.mm")][, intake_day_of_the_week := as.character(intake_day_of_the_week)] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  facet_grid(intake_day_of_the_week ~., labeller = labeller(intake_day_of_the_week = labels)) +
  labs(x = "Time of the Day", 
       y = "Average Total Saturated Fatty Acid Consumption (grams)",
       title = "Average Total Saturated Fatty Acid Consumption vs Time of Day by Day of Week")
```
Make plots above bigger

