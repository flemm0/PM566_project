---
title: "PM566 Midterm Project"
author: "Flemming Wu"
date: "`r Sys.Date()`"
output: github_document
always_allow_html: true
---


Main source of data:

https://www.ars.usda.gov/northeast-area/beltsville-md-bhnrc/beltsville-human-nutrition-research-center/food-surveys-research-group/docs/wweia-documentation-and-data-sets/


Questions:\
Insulin resistance and diabetes is a growing health issue for Americans. When foods with a high glycemic index (causing a rapid rise in blood sugar) are consumed, the pancreas must pump insulin to move sugar from the blood back into the cells. Over time, if these foods are constantly being consumed, the cells stop responding to insulin and the normal blood sugar level rises. This leads to weight gain, as excess blood sugar is sent to be stored as body fat, and sets the stage for prediabetes and type 2 diabetes.\
While there are many other factors that influence the development of insulin resistance and diabetes such as lifestyle, environmental factors, and genetics, in this project, I will only be investigating factors affecting our food choices using the NHANES (National Health and Nutrition Examination Survey) data. More specifically, I examined the data that was collected in What We Eat in America (WWEIA), the dietary interview component of the NHANES. I will use the data to investigate the following questions that I have asked:\

* What time and/or day of the week do people generally eat foods high in sugar or saturated fatty acids (FA)?
* Does sugar or saturated fa consumption vary by age, ethnicity, or gender?
* Does the source of food or whether the meal was eaten at home have an effect on sugar or saturated fa consumption?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
#setwd("~/Desktop/PM566/midterm")
```

```{r load libraries, warning=FALSE, message=FALSE}
library(haven)
library(data.table)
library(tidyverse)
library(httr)
library(xml2)
library(rvest)
```

```{r Read in data sets from website, cache = TRUE}
fs_d1 <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.xpt")
fs_d2 <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR2IFF.xpt")
demographic <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DEMO.xpt")
food_categories <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_drxfcd.xpt")
```

```{r Changing column names, warning = FALSE}
# Get get all of the column labels in a data frame
fs_d1_labels <- purrr::map_df(fs_d1, ~attributes(.x))
fs_d2_labels <- purrr::map_df(fs_d2, ~attributes(.x))


demographic_labels <- purrr::map_df(demographic, ~attributes(.x))

fc_labels <- purrr::map_df(food_categories, ~attributes(.x))


# gsub() the spaces to underscores and put into vector
fs_d1_labels <- gsub(" ", "_", fs_d1_labels$label) 
fs_d1_labels <-  gsub("\\(|\\)", "", fs_d1_labels) %>%
  as.vector() %>%
  tolower() %>%
  unique()

fs_d2_labels <- gsub(" ", "_", fs_d2_labels$label) 
fs_d2_labels <-  gsub("\\(|\\)", "", fs_d2_labels) %>%
  as.vector() %>%
  tolower() %>%
  unique()

demographic_labels <- gsub(" ", "_", demographic_labels$label) %>%
  as.vector() %>%
  tolower()

fc_labels <- gsub(" ", "_", fc_labels$label) %>%
  as.vector() %>%
  tolower()
 

#reassign names
names(fs_d1) <- fs_d1_labels
names(fs_d1) <- make.names(names(fs_d1))

names(fs_d2) <- fs_d2_labels
names(fs_d2) <- make.names(names(fs_d2))

names(demographic) <- demographic_labels

names(food_categories) <- fc_labels
```

```{r convert to data tables}
fs_d1 <- as.data.table(fs_d1)
fs_d2 <- as.data.table(fs_d2)
food_categories <- as.data.table(food_categories)
demographic <- as.data.table(demographic)
```


```{r remove columns that are not needed}
fs_d1 <- fs_d1[, c(1:30)]
fs_d2 <- fs_d2[, c(1:30)]
demographic <- demographic[, respondent_sequence_number:pregnancy_status_at_exam]
food_categories <- food_categories[, -(former_short_food_code_description:former_long_food_code_description)]
```

```{r decoding categorical variables in demographic table}
demographic[, `interview/examination_status` := fifelse(`interview/examination_status` == 1, "interview_only", "interview_and_mec_examined")]

demographic[, gender := fifelse(gender == 1, "male", "female")]

demographic[, `race/hispanic_origin` := fifelse(`race/hispanic_origin` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin` == 4, "non-hispanic_black", "other_race_incl_multiracial"))))]

demographic[, `race/hispanic_origin_w/_nh_asian` := fifelse(`race/hispanic_origin_w/_nh_asian` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin_w/_nh_asian` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin_w/_nh_asian` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin_w/_nh_asian` == 4, "non-hispanic_black", 
                                                                           fifelse(`race/hispanic_origin_w/_nh_asian` == 6, "non-hispanic_asian", "other_race_incl_multiracial")))))]

demographic[, six_month_time_period := fifelse(six_month_time_period == 1, "nov1-apr30", 
                                               fifelse(six_month_time_period == 2, "may1-oct31", NA_character_))]

demographic[, country_of_birth := fifelse(country_of_birth == 1, "united_states", 
                                          fifelse(country_of_birth == 2, "other",
                                                  fifelse(country_of_birth == 77, "refused", "dont_know")))]

demographic[, length_of_time_in_us := fifelse(length_of_time_in_us == 1, "less_than_5", 
                                              fifelse(length_of_time_in_us == 2, "between_5_and_15",
                                                      fifelse(length_of_time_in_us == 3, "between_15_and_30",
                                                              fifelse(length_of_time_in_us == 4, "30_or_more",
                                                                      fifelse(length_of_time_in_us == 77, "refused", 
                                                                              fifelse(length_of_time_in_us == 99, "dont_know", NA_character_))))))]

demographic[, pregnancy_status_at_exam := fifelse(pregnancy_status_at_exam == 1, "pregnant",
                                                  fifelse(pregnancy_status_at_exam == 2, "not_pregnant",
                                                          fifelse(pregnancy_status_at_exam == 3, "cannot_ascertain", NA_character_)))]
```


```{r create age category variable for demographic table}
demographic[, age_category := fifelse(age_in_years_at_screening == 0, "<1",
                              fifelse(age_in_years_at_screening %between% c(1,3), "1-3",
                              fifelse(age_in_years_at_screening %between% c(4,8), "4-8",
                              fifelse(age_in_years_at_screening %between% c(9,13), "9-13",
                              fifelse(age_in_years_at_screening %between% c(14,18), "14-18",
                              fifelse(age_in_years_at_screening %between% c(19,30), "19-30",
                              fifelse(age_in_years_at_screening %between% c(31,50), "31-50", 
                              fifelse(age_in_years_at_screening %between% c(51,70), "51-70", "70+"))))))))]
```

```{r Categorize food survey day 1 using fifelse}
# columns needed: day of the week, name of eating occasion, source of food, and if the food was eaten at home categorized
# create new column for this so it can still be ordered
fs_d1[, intake_day_cat := fifelse(intake_day_of_the_week == 1, "Sunday",
                                          fifelse(intake_day_of_the_week == 2, "Monday",
                                                  fifelse(intake_day_of_the_week == 3, "Tuesday",
                                                          fifelse(intake_day_of_the_week == 4, "Wednesday",
                                                                  fifelse(intake_day_of_the_week == 5, "Thursday", 
                                                                          fifelse(intake_day_of_the_week == 6, "Friday", "Saturday"))))))]

#table(fs_d1$`did_you_eat_this_meal_at_home?`) #1, 2, and 9 are the only answers
fs_d1[, `did_you_eat_this_meal_at_home.` := fifelse(`did_you_eat_this_meal_at_home.` == 1, "yes",
                                                    fifelse(`did_you_eat_this_meal_at_home.` == 2, "no", "dont_know"))]
```

```{r categorize food survey day 1 using xpath and merge}

# for the next categorization steps, I will be reading in tables from the CDC website because they contain many possible values

# categorize the name of eating occasion
# read in name of eating occasion table from CDC website using html and full Xpath
eating_occasion <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[15]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

# merge table into original data table
fs_d1 <- merge(
  x = eating_occasion,
  y = fs_d1,
  by.x = "Code.or.Value",
  by.y = "name_of_eating_occasion"
)

# the merge replaced the old column "name_of_eating_occasion" with "Code.or.Value" from the new table
# I only need the "Value.Description" column so rename it and remove "Code.or.Value" column
setnames(fs_d1, "Value.Description", "eating_occasion")
fs_d1 <- fs_d1[-c(1)]

######################################

# categorize source of food
source_of_food <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[16]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

fs_d1 <- merge(
  x = source_of_food,
  y = fs_d1,
  by.x = "Code.or.Value",
  by.y = "source_of_food"
)

setnames(fs_d1, "Value.Description", "food_source")
fs_d1 <- fs_d1[-c(1)]
```


```{r Categorize food survey day 2 variables}
# columns needed: day of the week, name of eating occasion, source of food, and if the food was eaten at home categorized
# create new column for this so it can still be ordered
fs_d2[, intake_day_cat := fifelse(intake_day_of_the_week == 1, "Sunday",
                                          fifelse(intake_day_of_the_week == 2, "Monday",
                                                  fifelse(intake_day_of_the_week == 3, "Tuesday",
                                                          fifelse(intake_day_of_the_week == 4, "Wednesday",
                                                                  fifelse(intake_day_of_the_week == 5, "Thursday", 
                                                                          fifelse(intake_day_of_the_week == 6, "Friday", "Saturday"))))))]

#table(fs_d1$`did_you_eat_this_meal_at_home?`) #1, 2, and 9 are the only answers
fs_d2[, `did_you_eat_this_meal_at_home.` := fifelse(`did_you_eat_this_meal_at_home.` == 1, "yes",
                                                    fifelse(`did_you_eat_this_meal_at_home.` == 2, "no", "dont_know"))]


# for the next categorization steps, I will be reading in tables from the CDC website because they contain many possible values

# categorize the name of eating occasion
# read in name of eating occasion table from CDC website using html and full Xpath
eating_occasion <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[15]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

# merge table into original data table
fs_d2 <- merge(
  x = eating_occasion,
  y = fs_d2,
  by.x = "Code.or.Value",
  by.y = "name_of_eating_occasion"
)

# the merge replaced the old column "name_of_eating_occasion" with "Code.or.Value" from the new table
# I only need the "Value.Description" column so rename it and remove "Code.or.Value" column
setnames(fs_d2, "Value.Description", "eating_occasion")
fs_d2 <- fs_d2[-c(1)]

######################################

# categorize source of food
source_of_food <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[16]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

fs_d2 <- merge(
  x = source_of_food,
  y = fs_d2,
  by.x = "Code.or.Value",
  by.y = "source_of_food"
)

setnames(fs_d2, "Value.Description", "food_source")
fs_d2 <- fs_d2[-c(1)]
```


```{r create columns to identify difference between day 1 and day 2 interview records}
fs_d1 <- as.data.table(fs_d1)
fs_d2 <- as.data.table(fs_d2)
fs_d1[, interview_day := "Day 1"]
fs_d2[, interview_day := "Day 2"]
```

```{r combine both days food survey into one dataframe}
fs <- rbind(fs_d1, fs_d2)
```

### Preliminary Results



```{r merge data and begin EDA}
#### Exploratory Data Analysis


# First merge all the data tables into one

df <- merge(
  x = merge(
        x = fs, 
        y = demographic,
        by.x = "respondent_sequence_number",
        by.y = "respondent_sequence_number"
  ),
  y = food_categories,
  by.x = "usda_food_code",
  by.y = "food_code"
)

df <- as.data.table(df)
```

```{r check dimensions headers and footers, results='hide'}
dim(df)
head(df)
tail(df)
```

```{r check variable types, results = "hide"}
str(df)
```

```{r summary tables of total sugar and fat consumption, results = "hide"}
# Check key variables and provide summary statistics in tabular form
# First, check the predicted variables

quantile(df$total_sugars_gm, seq(0, 1, 0.1))

quantile(df$total_saturated_fatty_acids_gm, seq(0, 1, 0.1))
```
```{r view total sugar and fat measurements in food items, results = "hide", warning = FALSE}
#Some food items seem to be high in sugars and saturated fats, lets see what it makes sense

df[total_sugars_gm > 200, .(unique(long_food_code_description), total_sugars_gm)] %>%
  head(n = 20) 

df[total_saturated_fatty_acids_gm > 50, 
                   .(unique(long_food_code_description), total_saturated_fatty_acids_gm)] %>%
  head(n = 20)
```

```{r check predictor variables, results = 'hide'}
unique(df$food_source)
unique(df$eating_occasion)
unique(df$did_you_eat_this_meal_at_home.)
unique(df$intake_day_of_the_week)
summary(df$age_in_years_at_screening)
unique(df$gender)
unique(df$`race/hispanic_origin_w/_nh_asian`)
```


Summary tables
```{r sugar fat consumption by day of week}
# average and standard deviation of sugar consumption and saturated fatty acid consumption by day of the week
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ),
   by = c("intake_day_of_the_week", "intake_day_cat")][order(intake_day_of_the_week)][, intake_day_cat:num_observations] %>%
  knitr::kable(col.names = c("Day of Food Intake", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))

```
From the summary table above, it can be observed that average sugar and saturated fat consumption is slightly higher on the weekends, and are closely followed by Friday and Wednesday.
 
```{r sugar fat consumption by time of consumption}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = hour(time_of_eating_occasion_hh.mm)][order(hour)] %>%
  knitr::kable(col.names = c("Hour of the Day (0 = 12:00 AM - 12:59 AM, 23 = 11:00 PM - 11:59 PM)", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
From the summary table above, which groups sugar and saturated fat consumption by the hours that they were consumed, it can be seen that higher sugar and saturated fat consumption occurs between the hours of 8PM to 2AM. Additionally, 3PM and 4PM also had slightly higher sugar and saturated fat consumption.

```{r sugar and saturated fat consumption by eating occasion}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = eating_occasion][order(-avg_total_sugar, -avg_total_sat_fa)] %>%
  knitr::kable(col.names = c("Eating Occasion", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
From the summary table above, we can see that eating occasions that are more considered to be more formal meals, such as dinner, lunch, almuerzo, desayano, supper, etc. generally involve less consumption of sugar than do informal eating occasions such as snacks. The reverse is true for saturated fatty acid consumption, as the average grams consumed for these are higher in more formal eating occasions.

```{r sugar and saturated fat consumption by age category}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N,
     min(age_in_years_at_screening)
     ), 
   by = "age_category"][order(V6)][, !c("V6")] %>%
  knitr::kable(col.names = c("Age Range", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
The summary table above shows that average sugar and fatty acid consumption increases from birth until the ages of 14-18, and then decreases after age 18.

```{r sugar and saturated fat consumption by gender}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "gender"] %>%
  knitr::kable(col.names = c("Gender", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
From the table above, it can be seen that males consume higher amounts of sugar and saturated fatty acids on average.

```{r sugar and saturated fat consumption by ethnicity}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "race/hispanic_origin_w/_nh_asian"] %>%
  knitr::kable(col.names = c("Race", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
The groups with the highest average sugar and saturated fatty acid consumption are "other race including multiracial" and "non-hispanic black", and they are closely followed by "non-hispanic white".

```{r sugar and saturated fat consumption by source of food}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "food_source"][order(-avg_total_sugar, -avg_total_sat_fa)] %>%
  knitr::kable(col.names = c("Food Source", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
High average sugar consumption can be seen to come from food sources such as vending machines and convenience stores, likely due to the sale of sugar-sweetened beverages. High saturated fatty acid consumption can be seen to come from food sources such as fish (due to naturally occurring omega fatty acids in fish) as well as fast food restaurants and recreational facilities.

```{r sugar and saturated fat consumption by where meal was eaten}
df[, 
   .(avg_total_sugar = mean(total_sugars_gm), 
     std_total_sugar = sd(total_sugars_gm),
     avg_total_sat_fa = mean(total_saturated_fatty_acids_gm),
     std_total_sat_fa = sd(total_saturated_fatty_acids_gm),
     num_observations = .N
     ), 
   by = "did_you_eat_this_meal_at_home."][order(-avg_total_sugar)] %>%
  knitr::kable(col.names = c("Meal Eaten at Home", 
                             "Average Total Sugar Consumption",
                             "Standard Deviation of Total Sugar Consumption",
                             "Average Total Saturated Fatty Acid Consumption",
                             "Standard Deviation of Total Saturated Fatty Acid Consumption",
                             "Number of Observations"))
```
The table above reveals that food not eaten at home is generally slightly higher in average sugars and saturated fatty acids.




### Data Visualization


#### What time and/or day of the week do people generally eat foods high in sugar/saturated fats?
```{r plot sugar and saturated fa consumption against time, message=FALSE, fig.height = 8, fig.width = 12, fig.align = "center"}
#Plot sugar consumption versus time.

df[, .(mean(total_sugars_gm)), by = "time_of_eating_occasion_hh.mm"] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  geom_smooth(formula = y ~ x, alpha = 0.01, se = FALSE, linetype="dashed") +
  labs(x = "Hour of the Day (0 = 12:00 AM - 12:59 AM, 23 = 11:00 PM - 11:59 PM)",
       y = "Average Total Sugar Consumption (grams)",
       title = "Average Sugar Consumption vs Hour of the Day")

df[, .(mean(total_saturated_fatty_acids_gm)), by = "time_of_eating_occasion_hh.mm"] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  geom_smooth(formula = y ~ x, alpha = 0.01, se = FALSE, linetype="dashed") +
  labs(x = "Hour of the Day (0 = 12:00 AM - 12:59 AM, 23 = 11:00 PM - 11:59 PM)",
       y = "Average Total Saturated Fatty Acid Consumption (grams)",
       title = "Average Saturated Fatty Acid Consumption vs Hour of the Day")
```
The plots above reveal that average sugar consumption increases as the day progresses, with large spikes at around 4:00 PM, 6:00 PM, 9:00 PM and 4:00 AM. A similar trend can be observed for saturated fatty acid consumption, with a large spike at around 12:00 PM and 10:30 PM.

```{r plot sugar and saturated fa consumption against time grouped by day of the week, fig.height = 8, fig.width = 12, fig.align = "center"}
labels <- c("1" = "Sunday", "2" = "Monday", "3" = "Tuesday", "4" = "Wednesday", "5" = "Thursday", "6" = "Friday", "7" = "Saturday")  

#sugars
df[, .(mean(total_sugars_gm)), by = c("intake_day_of_the_week", "time_of_eating_occasion_hh.mm")][, intake_day_of_the_week := as.character(intake_day_of_the_week)] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  facet_grid(intake_day_of_the_week ~., labeller = labeller(intake_day_of_the_week = labels)) +
  labs(x = "Time of the Day", 
       y = "Average Total Sugar Consumption (grams)",
       title = "Average Total Sugar Consumption vs Time of Day by Day of Week")

#saturated fa
df[, .(mean(total_saturated_fatty_acids_gm)), by = c("intake_day_of_the_week", "time_of_eating_occasion_hh.mm")][, intake_day_of_the_week := as.character(intake_day_of_the_week)] %>%
  ggplot(mapping = aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  geom_line() +
  facet_grid(intake_day_of_the_week ~., labeller = labeller(intake_day_of_the_week = labels)) +
  labs(x = "Time of the Day", 
       y = "Average Total Saturated Fatty Acid Consumption (grams)",
       title = "Average Total Saturated Fatty Acid Consumption vs Time of Day by Day of Week")
```
The plots above reveal that sugar consumption is higher towards the evening for Monday through Wednesday. Additionally, there are spikes in sugar consumption in the morning around 9:30 AM on Wednesday and 5:30 AM on Thursday. Averages for sugar consumption tend to be more consistent throughout the 24 hour period on Friday, Saturday, and Sunday. \
Averages for saturated fatty acid consumption are generally more consistent than sugar consumption, but there is an interesting large spike in consumption towards the end of the day on Wednesday. It can also be noted that there are more spikes in saturated fatty acid consumption on Saturday and Sunday.


```{r plot sugar and saturated fa consumption by eating occasion, warning=FALSE, fig.height = 8, fig.width = 12, fig.align = "center"}
#Sugar
df[!is.na(eating_occasion) & !is.na(total_sugars_gm)] %>%
  ggplot(mapping = aes(x = forcats::fct_reorder(factor(eating_occasion),
    total_sugars_gm, mean), y = total_sugars_gm)) +
  stat_summary(fun.data = mean_se, geom = "errorbar") +
  stat_summary(fun = mean, size = 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1)) +
  labs(x = "Name of Eating Occasion", y = "Average Grams Sugar Consumption", title = "Sugar Consumption vs Eating Occasion")

#Saturated Fatty Acid
df[!is.na(eating_occasion) & !is.na(total_saturated_fatty_acids_gm)] %>%
  ggplot(mapping = aes(x = forcats::fct_reorder(factor(eating_occasion),
    total_saturated_fatty_acids_gm, mean), y = total_saturated_fatty_acids_gm)) +
  stat_summary(fun.data = mean_se, geom = "errorbar") +
  stat_summary(fun = mean, size = 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1)) +
  labs(x = "Name of Eating Occasion", y = "Average Grams Saturated Fatty Acid Consumption", title = "Saturated Fatty Acid Consumption vs Eating Occasion")
```
The plots above reveal that average sugar consumption is lowest in meals eaten later in the day such as lunch and dinner, increases for earlier meals such as breakfast or brunch, and is highest in the snack and extended consumption categories. For average saturated fatty acid consumption, the trend can be described as an increase in consumption with more formal meal categories, such as brunch, dinner, and supper. However, snacking is also associated with higher average saturated fatty acid consumption. As expected, bebida, or drinks, are associated with the lowest saturated fatty acid consumption.


#### Does sugar / saturated fatty acid consumption vary by age, ethnicity, gender?
**need to average observations for people that had recordings in day 1 and day 2**

```{r sugar and sat fa consumption by age, fig.height = 8, fig.width = 12, fig.align = "center"}
# sugars
unique(df[, .(sugar_consumption = sum(total_sugars_gm), age_category, gender), by = "respondent_sequence_number"]) %>%
  ggplot(mapping= aes(x = factor(age_category, levels = c("<1", "1-3", "4-8", "9-13", "14-18", "19-30", "31-50", "51-70", "70+")), y = sugar_consumption, fill = gender)) +
  geom_violin() +
  stat_summary(fun = median, geom = "point", position = position_dodge(0.9)) +
  labs(x = "Age Range", y = "Sugar Consumption (grams) in 24 Hours", title = "Sugar Consumption vs Age", fill = "Gender")


# saturated fa
unique(df[, .(sat_fa_consumption = sum(total_saturated_fatty_acids_gm), age_category, gender), by = "respondent_sequence_number"]) %>%
  ggplot(mapping = aes(x = factor(age_category, levels = c("<1", "1-3", "4-8", "9-13", "14-18", "19-30", "31-50", "51-70", "70+")), y = sat_fa_consumption, fill = gender)) +
  geom_violin() +
  stat_summary(fun = median, geom = "point", position = position_dodge(0.9)) +
  labs(x = "Age Range", y = "Saturated FA Consumption (grams) in 24 Hours", title = "Saturated FA Consumption vs Age", fill = "Gender")
```
The violin plots above reveal several trends in average sugar and saturated fatty acid consumption: first, that consumption is higher on average for males than females. Secondly, the trend in average consumption increases until age 18, and then decreases with age. Lastly, the range of values tends to increase with increasing age, especially so for males.

```{r sugar and sat fa consumption by ethnicity, fig.height = 8, fig.width = 12, fig.align = "center"}
#sugar
unique(df[, .(sugar_consumption = sum(total_sugars_gm), `race/hispanic_origin_w/_nh_asian`, gender), by = "respondent_sequence_number"]) %>%
  ggplot(mapping = aes(x = `race/hispanic_origin_w/_nh_asian`, y = sugar_consumption, fill = gender)) +
  geom_violin() +
  stat_summary(fun = median, geom = "point", position = position_dodge(0.9)) +
  labs(x = "Ethnicity", y = "Sugar Consumption (grams) in 24 Hours", title = "Sugar Consumption vs Ethnicity", fill = "Gender")



#saturated fa
unique(df[, .(sat_fa_consumption = sum(total_saturated_fatty_acids_gm), `race/hispanic_origin_w/_nh_asian`, gender), by = "respondent_sequence_number"]) %>%
  ggplot(mapping = aes(x = `race/hispanic_origin_w/_nh_asian`, y = sat_fa_consumption, fill = gender)) +
  geom_violin() +
  stat_summary(fun = median, geom = "point", position = position_dodge(0.9)) +
  labs(x = "Ethnicity", y = "Saturated FA Consumption (grams) in 24 Hours", title = "Sugar Consumption vs Ethnicity", fill = "Gender")
```
In grouping average sugar and saturated fatty acid consumption by ethnicity, there is not much variation between ethnicity groups and sugar consumption, however, the lowest average sugar and saturated fatty acid consumption and range of values is lowest in the non hispanic asian group, and highest in non hispanic black group.

#### Does the source of the food or whether the meal was eaten at home have an effect?

```{r plot meal eaten at home, fig.height = 8, fig.width = 12, fig.align = "center"}
#sugar
ggplot(data = df, mapping = aes(x = log10(total_sugars_gm + 1), fill = did_you_eat_this_meal_at_home.)) +
  geom_histogram(bins = 200, alpha = 0.5) +
  labs(x = "Log10 + 1 of Total Sugar Consumption", y = "Number of Observations", title = "Log Transformation of Sugar Consumption vs Whether Meal Was Eaten at Home", fill = "Meal Eaten at Home")


#saturated fa
ggplot(data = df, mapping = aes(x = log10(total_saturated_fatty_acids_gm + 1), fill = did_you_eat_this_meal_at_home.)) +
  geom_histogram(bins = 200, alpha = 0.5) +
  labs(x = "Log10 + 1 of Total Saturated FA Consumption", y = "Number of Observations", title = "Log Transformation of Saturated FA Consumption vs Whether Meal Was Eaten at Home", fill = "Meal Eaten at Home")

```
The plots above graph the log normalized distribution of sugar and saturated fatty acid in foods eaten at home, not at home and unknown. It can be seen that the distributions of foods eaten at home and not at home are essentially the same for both sugar and saturated fatty acids.

```{r plot source of food, warning=FALSE, fig.height = 8, fig.width = 12, fig.align = "center"}
#sugars
df[!is.na(food_source) & !is.na(total_sugars_gm)] %>%
  ggplot(mapping = aes(x = forcats::fct_reorder(factor(food_source), 
                                                total_sugars_gm, mean), y = total_sugars_gm)) +
  stat_summary(fun.data = mean_se, geom = "errorbar") +
  stat_summary(fun = mean, size = 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1)) +
  labs(x = "Source of Food", y = "Total Sugar Consumption (grams)", title = "Sugar Consumption vs Source of Food")


#saturated fa
df[!is.na(food_source) & !is.na(total_sugars_gm)] %>%
  ggplot(mapping = aes(x = forcats::fct_reorder(factor(food_source),
                                                           total_saturated_fatty_acids_gm, mean), y = total_saturated_fatty_acids_gm)) +
  stat_summary(fun.data = mean_se, geom = "errorbar") +
  stat_summary(fun = mean, size = 0.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1)) +
  labs(x = "Source of Food", y = "Total Saturated FA Consumption (grams)", title = "Saturated FA Consumption vs Source of Food")
```

```{r plot correlation between total saturated fatty acid consumption and sugar consumption}
df[, .(sugar_consumption = sum(total_sugars_gm), sat_fa_consumption = sum(total_saturated_fatty_acids_gm)), by = "respondent_sequence_number"] %>%
  ggplot(mapping = aes(x = sugar_consumption, y = sat_fa_consumption)) +
  geom_jitter(size = 0.7) +
  geom_smooth(method = "lm", formula = y ~ x, color = "red", linetype = "dashed", se = FALSE) +
  labs(x = "Average 24 Hour Sugar Consumption Per Person", y = "Average 24 Hour Saturated Fatty Acid Consumption Per Person", title = "Sugar Consumption vs Saturated Fatty Acid Consumption")
```
```{r}
df_grouped <- df[, .(sugar_consumption = sum(total_sugars_gm), sat_fa_consumption = sum(total_saturated_fatty_acids_gm)), by = "respondent_sequence_number"]
cor(df_grouped$sugar_consumption, df_grouped$sat_fa_consumption, use = "complete")
```


