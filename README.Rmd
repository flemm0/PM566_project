---
title: "PM566 Midterm Project"
author: "Flemming Wu"
date: "`r Sys.Date()`"
output: github_document
always_allow_html: true
---


Main source of data:

https://www.ars.usda.gov/northeast-area/beltsville-md-bhnrc/beltsville-human-nutrition-research-center/food-surveys-research-group/docs/wweia-documentation-and-data-sets/


Questions:\
Insulin resistance and diabetes is a growing health issue for Americans. Causes of this includes consumption of foods high in carbohydrates and saturated fats, causing blood glucose levels to spike and insulin is needed to bring the blood glucose levels back down to normal. Over time, consistent high blood glucose spikes lead to the body becoming accustomed to high amounts of sugar, and therefore acquiring insulin resistance. In this project, I will be investigating what attributes cause people to eat foods that lead to blood glucose spikes.\

* What time and/or day of the week do people generally eat foods high in sugar/saturated fats?
* Does having a dietary restriction affect sugar/fat consumption?
* Does sugar consumption vary by age, ethnicity, gender, or pregnancy status?
* Does source of food or whether the meal was eaten at home have an effect?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
setwd("~/Desktop/PM566/midterm")
```

Load Libraries
```{r load libraries, warning=FALSE, message=FALSE}
library(haven)
library(data.table)
library(tidyverse)
library(dtplyr)
library(httr)
library(xml2)
library(rvest)
```

Read in data from CDC website
```{r Read in data sets from website, cache = TRUE}
fs_d1 <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.xpt")
demographic <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DEMO.xpt")
food_categories <- read_xpt("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_drxfcd.xpt")
```

Rename columns with the column labels provided
```{r Changing column names, warning = FALSE}
# Get get all of the column labels in a data frame
fs_d1_labels <- purrr::map_df(fs_d1, ~attributes(.x))

demographic_labels <- purrr::map_df(demographic, ~attributes(.x))

fc_labels <- purrr::map_df(food_categories, ~attributes(.x))


# gsub() the spaces to underscores and put into vector
fs_d1_labels <- gsub(" ", "_", fs_d1_labels$label) 
fs_d1_labels <-  gsub("\\(|\\)", "", fs_d1_labels) %>%
  as.vector() %>%
  tolower() %>%
  unique()

demographic_labels <- gsub(" ", "_", demographic_labels$label) %>%
  as.vector() %>%
  tolower()

fc_labels <- gsub(" ", "_", fc_labels$label) %>%
  as.vector() %>%
  tolower()
 

#reassign names
names(fs_d1) <- fs_d1_labels
names(fs_d1) <- make.names(names(fs_d1))

names(demographic) <- demographic_labels

names(food_categories) <- fc_labels
```

Convert to data table
```{r convert to data tables}
fs_d1 <- as.data.table(fs_d1)
food_categories <- as.data.table(food_categories)
demographic <- as.data.table(demographic)
```

Remove unnecessary columns
```{r}
fs_d1 <- fs_d1[, c(1:30)]
demographic <- demographic[, respondent_sequence_number:pregnancy_status_at_exam]
food_categories <- food_categories[, -(former_short_food_code_description:former_long_food_code_description)]
```

Change categorical columns from number codes to categorical variables in demographic table
```{r decoding categorical variables in demographic table}
demographic[, `interview/examination_status` := fifelse(`interview/examination_status` == 1, "interview_only", "interview_and_mec_examined")]

demographic[, gender := fifelse(gender == 1, "male", "female")]

demographic[, `race/hispanic_origin` := fifelse(`race/hispanic_origin` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin` == 4, "non-hispanic_black", "other_race_incl_multiracial"))))]

demographic[, `race/hispanic_origin_w/_nh_asian` := fifelse(`race/hispanic_origin_w/_nh_asian` == 1, "mexican_american",
                                                 fifelse(`race/hispanic_origin_w/_nh_asian` == 2, "other_hispanic",
                                                          fifelse(`race/hispanic_origin_w/_nh_asian` == 3, "non-hispanic_white",
                                                                   fifelse(`race/hispanic_origin_w/_nh_asian` == 4, "non-hispanic_black", 
                                                                           fifelse(`race/hispanic_origin_w/_nh_asian` == 6, "non-hispanic_asian", "other_race_incl_multiracial")))))]

demographic[, six_month_time_period := fifelse(six_month_time_period == 1, "nov1-apr30", 
                                               fifelse(six_month_time_period == 2, "may1-oct31", NA_character_))]

demographic[, country_of_birth := fifelse(country_of_birth == 1, "united_states", 
                                          fifelse(country_of_birth == 2, "other",
                                                  fifelse(country_of_birth == 77, "refused", "dont_know")))]

demographic[, length_of_time_in_us := fifelse(length_of_time_in_us == 1, "less_than_5", 
                                              fifelse(length_of_time_in_us == 2, "between_5_and_15",
                                                      fifelse(length_of_time_in_us == 3, "between_15_and_30",
                                                              fifelse(length_of_time_in_us == 4, "30_or_more",
                                                                      fifelse(length_of_time_in_us == 77, "refused", 
                                                                              fifelse(length_of_time_in_us == 99, "dont_know", NA_character_))))))]

demographic[, pregnancy_status_at_exam := fifelse(pregnancy_status_at_exam == 1, "pregnant",
                                                  fifelse(pregnancy_status_at_exam == 2, "not_pregnant",
                                                          fifelse(pregnancy_status_at_exam == 3, "cannot_ascertain", NA_character_)))]
```


Create age category variable for demographic table.
```{r create age category variable for demographic table}
demographic[, age_category := fifelse(age_in_years_at_screening %between% c(1,3), "1-3",
                                      fifelse(age_in_years_at_screening %between% c(4,8), "4-8",
                                              fifelse(age_in_years_at_screening %between% c(9,13), "9-13",
                                                      fifelse(age_in_years_at_screening %between% c(14,18), "14-18",
                                                              fifelse(age_in_years_at_screening %between% c(19,30), "19-30",
                                                                      fifelse(age_in_years_at_screening %between% c(31,50), "31-50", 
                                                                              fifelse(age_in_years_at_screening %between% c(51,70), "51-70", "70+")))))))]
```

Categorize the answers in the food survey. Need day of the week, name of eating occasion, source of food, and if the food was eaten at home categorized.
```{r Categorize food survey day 1 using fifelse}
fs_d1[, intake_day_of_the_week := fifelse(intake_day_of_the_week == 1, "Sunday",
                                          fifelse(intake_day_of_the_week == 2, "Monday",
                                                  fifelse(intake_day_of_the_week == 3, "Tuesday",
                                                          fifelse(intake_day_of_the_week == 4, "Wednesday",
                                                                  fifelse(intake_day_of_the_week == 5, "Thursday", 
                                                                          fifelse(intake_day_of_the_week == 6, "Friday", "Saturday"))))))]

#table(fs_d1$`did_you_eat_this_meal_at_home?`) #1, 2, and 9 are the only answers
fs_d1[, `did_you_eat_this_meal_at_home.` := fifelse(`did_you_eat_this_meal_at_home.` == 1, "yes",
                                                    fifelse(`did_you_eat_this_meal_at_home.` == 2, "no", "dont_know"))]
```

```{r categorize food survey day 1 using xpath and merge}

# for the next categorization steps, I will be reading in tables from the CDC website because they contain many possible values

# categorize the name of eating occasion
# read in name of eating occasion table from CDC website using html and full Xpath
eating_occasion <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[15]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

# merge table into original data table
fs_d1 <- merge(
  x = eating_occasion,
  y = fs_d1,
  by.x = "Code.or.Value",
  by.y = "name_of_eating_occasion"
)

# the merge replaced the old column "name_of_eating_occasion" with "Code.or.Value" from the new table
# I only need the "Value.Description" column so rename it and remove "Code.or.Value" column
setnames(fs_d1, "Value.Description", "eating_occasion")
fs_d1 <- fs_d1[-c(1)]

######################################

# categorize source of food
source_of_food <- read_html("https://wwwn.cdc.gov/NCHS/nhanes/2017-2018/P_DR1IFF.htm#DR1DAY") %>%
  html_nodes(xpath = "/html/body/div[2]/div[4]/div[16]/table") %>%
  html_table() %>%
  as.data.frame() %>%
  select(Code.or.Value, Value.Description)

fs_d1 <- merge(
  x = source_of_food,
  y = fs_d1,
  by.x = "Code.or.Value",
  by.y = "source_of_food"
)

setnames(fs_d1, "Value.Description", "food_source")
fs_d1 <- fs_d1[-c(1)]
```

```{r}
str(fs_d1)

str(demographic)
```

### Preliminary Results

Check key variables and provide summary statistics in tabular form.

First, check the predicted variables.
```{r summary tables of total sugar and fat consumption}
quantile(fs_d1$total_sugars_gm, seq(0, 1, 0.1)) %>%
  knitr::kable(col.names = "grams sugar in food item")

quantile(fs_d1$total_saturated_fatty_acids_gm, seq(0, 1, 0.1)) %>%
  knitr::kable(col.names = "grams saturated FA in food item")
```
Some food items seem to be high in sugars and saturated fats, lets see what it makes sense
```{r view total sugar and fat measurements in food items}
survey_cats_merged <- merge(
  x = fs_d1,
  y = food_categories,
  by.x = "usda_food_code",
  by.y = "food_code"
)

survey_cats_merged <- as.data.table(survey_cats_merged)

survey_cats_merged[total_sugars_gm > 200, .(unique(long_food_code_description), total_sugars_gm)] %>%
  head(n = 20) %>%
  knitr::kable(col.names = c("Food item", "grams sugar in food item"))

survey_cats_merged[total_saturated_fatty_acids_gm > 50, 
                   .(unique(long_food_code_description), total_saturated_fatty_acids_gm)] %>%
  head(n = 20) %>%
  knitr::kable(col.names = c("Food item", "grams saturated FA in food item"))
```

Next, check the predictor variables.
```{r check predictor variables}
#fs_d1[, .(mean(total_sugars_gm)), by = "time_of_eating_occasion_hh.mm"]
unique(fs_d1$food_source)
unique(fs_d1$eating_occasion)
unique(fs_d1$did_you_eat_this_meal_at_home.)
unique(fs_d1$intake_day_of_the_week)
summary(demographic$age_in_years_at_screening)
unique(demographic$gender)
unique(demographic$`race/hispanic_origin_w/_nh_asian`)
```














#### What time and/or day of the week do people generally eat foods high in sugar/saturated fats?
Plot sugar consumption versus time.
```{r plot sugar consumption against time}
# make names for food survey table and convert back to data table
fs_d1 <- as.data.table(fs_d1)


fs_d1[, mean(total_sugars_gm), by = c("time_of_eating_occasion_hh.mm", "intake_day_of_the_week")] %>%
  ggplot() +
  geom_line(aes(x = time_of_eating_occasion_hh.mm, y = V1)) +
  facet_wrap(~intake_day_of_the_week, nrow = 3)
```


